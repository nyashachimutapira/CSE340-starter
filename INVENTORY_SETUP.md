# Inventory Management Setup & Migration Guide

Quick setup guide for enabling the inventory management and checkout system.

## Prerequisites

- Node.js server running
- PostgreSQL database
- Express.js application (already configured)
- Shopping cart system (already implemented)
- Authentication system (JWT)

## Step 1: Database Migration

Run the database rebuild script to add new tables:

```bash
# Option 1: Using database/rebuild.sql (recommended)
# This creates/updates:
# - inventory table with inv_quantity column
# - orders table
# - order_items table

# In your database client (psql, pgAdmin, etc.):
psql -U postgres -d your_database < database/rebuild.sql
```

Or manually run these commands:

```sql
-- Add stock quantity to inventory
ALTER TABLE public.inventory 
ADD COLUMN inv_quantity INT NOT NULL DEFAULT 1 CHECK (inv_quantity >= 0);

-- Create orders table
CREATE TABLE IF NOT EXISTS public.orders (
  order_id INT GENERATED BY DEFAULT AS IDENTITY,
  account_id INT NOT NULL REFERENCES public.account(account_id) ON DELETE CASCADE,
  order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  total_amount NUMERIC(10, 2) NOT NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'confirmed', 'shipped', 'delivered', 'cancelled')),
  CONSTRAINT orders_pkey PRIMARY KEY (order_id)
);

-- Create order_items table
CREATE TABLE IF NOT EXISTS public.order_items (
  order_item_id INT GENERATED BY DEFAULT AS IDENTITY,
  order_id INT NOT NULL REFERENCES public.orders(order_id) ON DELETE CASCADE,
  inv_id INT NOT NULL REFERENCES public.inventory(inv_id) ON DELETE RESTRICT,
  quantity INT NOT NULL CHECK (quantity > 0),
  price_at_purchase NUMERIC(9, 0) NOT NULL,
  CONSTRAINT order_items_pkey PRIMARY KEY (order_item_id)
);
```

## Step 2: Verify Database Changes

```sql
-- Check inventory table has inv_quantity
\d inventory;

-- Should show: inv_quantity | integer | NOT NULL

-- Verify orders table created
\d orders;

-- Verify order_items table created
\d order_items;

-- Check current stock
SELECT inv_id, inv_make, inv_model, inv_quantity FROM inventory;
```

## Step 3: Update Initial Stock Values (Optional)

If you want to set specific stock levels for each vehicle:

```sql
-- Set all vehicles to stock of 1 (default)
UPDATE inventory SET inv_quantity = 1;

-- Or set specific stock levels
UPDATE inventory SET inv_quantity = 5 WHERE inv_make = 'Chevy';
UPDATE inventory SET inv_quantity = 2 WHERE inv_make = 'Lamborghini';
UPDATE inventory SET inv_quantity = 0 WHERE inv_make = 'Ferrari'; -- Out of stock
```

## Step 4: Verify Files Are in Place

Check that all new files exist:

```bash
# Models
- models/inventory-management-model.js ✓
- models/order-management-model.js ✓

# Controllers
- controllers/checkoutController.js ✓

# Routes
- routes/checkoutRoute.js ✓

# Views
- views/checkout/view.ejs ✓
- views/checkout/confirmation.ejs ✓
- views/checkout/order-history.ejs ✓

# Documentation
- INVENTORY_MANAGEMENT_GUIDE.md ✓
- INVENTORY_SETUP.md ✓
```

## Step 5: Verify Server Configuration

Check that `server.js` includes:

```javascript
// Line 31: Import checkout route
const checkoutRoute = require("./routes/checkoutRoute");

// Line 94: Register checkout route
app.use("/checkout", checkoutRoute);
```

## Step 6: Test the System

### Test 1: Add Item to Cart
1. Login to application
2. Navigate to vehicle detail page
3. Click "Add to Cart"
4. Verify item appears in cart

### Test 2: View Checkout
1. Go to /cart
2. Click "Proceed to Checkout"
3. Verify checkout page displays
4. Check that cart items and total are correct

### Test 3: Complete Purchase
1. On checkout page, click "Complete Purchase"
2. Verify order is created
3. Check confirmation page shows order number
4. Verify total matches cart total

### Test 4: Verify Inventory Reduced
```sql
-- After purchase, verify inventory decreased
SELECT inv_id, inv_quantity FROM inventory WHERE inv_id = 1;
-- Should be reduced by 1 from before purchase
```

### Test 5: View Order History
1. Click "View Order History" or go to /checkout/order-history
2. Verify orders appear in list
3. Click order to view details
4. Verify correct items and price

## Step 7: Create Database Indexes (Recommended)

For better performance with larger datasets:

```sql
-- Speed up order lookups
CREATE INDEX idx_orders_account ON orders(account_id);
CREATE INDEX idx_order_items_order ON order_items(order_id);

-- Speed up stock checks
CREATE INDEX idx_inventory_quantity ON inventory(inv_quantity);

-- Speed up order history
CREATE INDEX idx_orders_date ON orders(order_date DESC);
```

## Step 8: Monitor & Maintain

### Regular Checks

```sql
-- Check low stock items
SELECT inv_id, inv_make, inv_model, inv_quantity 
FROM inventory 
WHERE inv_quantity < 3 
ORDER BY inv_quantity;

-- Check total orders
SELECT COUNT(*) as total_orders FROM orders;

-- Check orders by status
SELECT status, COUNT(*) as count 
FROM orders 
GROUP BY status;

-- Check recent orders
SELECT * FROM orders 
ORDER BY order_date DESC 
LIMIT 10;
```

### Backup Database

Regular backups are essential:

```bash
# PostgreSQL backup command
pg_dump -U postgres -d your_database > backup_$(date +%Y%m%d).sql

# Restore from backup
psql -U postgres -d your_database < backup_20251203.sql
```

## Environment Variables

Ensure `.env` file has:

```env
# Database
DATABASE_URL=postgresql://user:password@localhost:5432/cse340

# Server
HOST=localhost
PORT=5500

# Session
SESSION_SECRET=your_secret_key

# JWT
JWT_SECRET=your_jwt_secret
```

## Troubleshooting

### Error: "relation 'orders' does not exist"
**Solution**: Run the migration script again to create tables

### Error: "column 'inv_quantity' does not exist"
**Solution**: Check inventory table migration ran successfully:
```sql
ALTER TABLE public.inventory 
ADD COLUMN inv_quantity INT NOT NULL DEFAULT 1 CHECK (inv_quantity >= 0);
```

### Error: "Cannot POST /checkout/process"
**Solution**: Verify checkoutRoute.js is imported and registered in server.js

### Error: "Please log in to checkout"
**Solution**: 
- Ensure you're logged in
- Check JWT token is valid
- Verify session is active

### Stock Not Reducing After Purchase
**Solution**:
- Check that order was actually created (should see in database)
- Verify transaction committed (check server logs)
- Run manual test:
```sql
SELECT COUNT(*) FROM orders;
SELECT * FROM inventory WHERE inv_id = 1;
```

## Next Steps

1. ✅ Set up database tables
2. ✅ Verify all files in place
3. ✅ Test checkout flow
4. ✅ Create database indexes
5. ⬜ (Optional) Add email notifications
6. ⬜ (Optional) Add payment processing
7. ⬜ (Optional) Create admin dashboard

## Quick Command Reference

```bash
# Start server with development mode
npm run dev

# Test database connection
node test-db-connection.js

# Run tests (if configured)
npm test

# Check database tables
psql -U postgres -d cse340 -c "\d"

# View recent orders
psql -U postgres -d cse340 -c "SELECT * FROM orders ORDER BY order_date DESC LIMIT 10;"
```

## Support

If you encounter issues:

1. **Check Server Logs**: Look for error messages in terminal
2. **Check Browser Console**: Press F12, go to Console tab
3. **Verify Database**: Connect with psql and run queries
4. **Review Documentation**: See INVENTORY_MANAGEMENT_GUIDE.md
5. **Check Migration Script**: Ensure rebuild.sql ran completely

---

**Setup Date**: 2025-12-03
**Status**: Ready for Testing
**Last Updated**: 2025-12-03
