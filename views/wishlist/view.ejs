<div class="wishlist-container">
  <h1>My Wishlist</h1>

  <% if (notices && notices.length > 0) { %>
    <div class="alerts">
      <% notices.forEach(notice => { %>
        <div class="alert alert-info"><%= notice %></div>
      <% }); %>
    </div>
  <% } %>

  <% if (errors && errors.length > 0) { %>
    <div class="alerts">
      <% errors.forEach(error => { %>
        <div class="alert alert-danger"><%= error.msg %></div>
      <% }); %>
    </div>
  <% } %>

  <% if (success && success.length > 0) { %>
    <div class="alerts">
      <% success.forEach(msg => { %>
        <div class="alert alert-success"><%= msg %></div>
      <% }); %>
    </div>
  <% } %>

  <% if (wishlistItems && wishlistItems.length > 0) { %>
    <div class="wishlist-summary">
      <p>Total Items: <strong><%= itemCount %></strong></p>
    </div>

    <div class="wishlist-grid">
      <% wishlistItems.forEach(item => { %>
        <div class="wishlist-item" data-wishlist-id="<%= item.wishlist_id %>">
          <div class="item-image">
            <a href="/inv/detail/<%= item.inv_id %>">
              <img src="<%= item.inv_image %>" alt="<%= item.inv_year %> <%= item.inv_make %> <%= item.inv_model %>">
            </a>
          </div>
          <div class="item-details">
            <h3>
              <a href="/inv/detail/<%= item.inv_id %>">
                <%= item.inv_year %> <%= item.inv_make %> <%= item.inv_model %>
              </a>
            </h3>
            <p class="price">Price: <strong>$<%= parseFloat(item.inv_price).toFixed(2) %></strong></p>
            <div class="item-actions">
              <button class="btn btn-success btn-sm add-to-cart" data-inv-id="<%= item.inv_id %>">
                Add to Cart
              </button>
              <button class="btn btn-danger btn-sm remove-item" data-wishlist-id="<%= item.wishlist_id %>">
                Remove
              </button>
            </div>
          </div>
        </div>
      <% }); %>
    </div>
  <% } else { %>
    <div class="alert alert-info">
      <p>Your wishlist is empty.</p>
      <a href="/inv" class="btn btn-primary">Browse Vehicles</a>
    </div>
  <% } %>
</div>

<!-- Toast container (ARIA live region) -->
<div id="toast-container" aria-live="polite" aria-atomic="true"></div>

<style>
  .wishlist-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }

  .wishlist-summary {
    background: #f0f0f0;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 5px;
  }

  .wishlist-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .wishlist-item {
    border: 1px solid #ddd;
    border-radius: 5px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: box-shadow 0.3s;
  }

  .wishlist-item:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }

  .item-image {
    height: 200px;
    overflow: hidden;
    background: #f5f5f5;
  }

  .item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .item-details {
    padding: 15px;
  }

  .item-details h3 {
    margin: 0 0 10px 0;
    font-size: 16px;
  }

  .item-details a {
    color: #007bff;
    text-decoration: none;
  }

  .item-details a:hover {
    text-decoration: underline;
  }

  .price {
    margin: 10px 0;
    font-size: 18px;
  }

  .item-actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }

  .item-actions .btn {
    flex: 1;
    padding: 8px;
    font-size: 12px;
  }

  .btn {
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    text-decoration: none;
    display: inline-block;
  }

  .btn-success {
    background: #28a745;
    color: white;
  }

  .btn-success:hover {
    background: #218838;
  }

  .btn-danger {
    background: #dc3545;
    color: white;
  }

  .btn-danger:hover {
    background: #c82333;
  }

  .btn-sm {
    padding: 6px 12px;
    font-size: 12px;
  }

  .btn-primary {
    background: #007bff;
    color: white;
    padding: 10px 20px;
  }

  .btn-primary:hover {
    background: #0056b3;
  }

  .alerts {
    margin-bottom: 20px;
  }

  .alert {
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 5px;
  }

  .alert-info {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    color: #0c5460;
  }

  .alert-success {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
  }

  .alert-danger {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
  }
  /* Focus outline for keyboard users */
  .btn:focus, .remove-item:focus, .add-to-cart:focus {
    outline: 3px solid #0056b3;
    outline-offset: 2px;
  }

  /* Toast styles */
  #toast-container { position: fixed; top: 16px; right: 16px; z-index: 1050; }
  .toast-item { min-width: 220px; max-width: 360px; background: #fff; border: 1px solid #ccc; padding: 10px 12px; margin-bottom: 8px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.12); display:flex; align-items:center; justify-content:space-between; }
  .toast-item.success { border-color: #c3e6cb; background: #d4edda; }
  .toast-item.error { border-color: #f5c6cb; background: #f8d7da; }
  .toast-message { flex: 1; padding-right: 8px; }
  .toast-close { background: transparent; border: none; cursor: pointer; font-size: 16px; }
</style>

<script>
  // Toast / queued notifications
  function showToast(message, type = 'info', timeout = 5000, announceTitle = '') {
    const container = document.getElementById('toast-container');
    if (!container) return;
    const toast = document.createElement('div');
    toast.className = 'toast-item ' + (type === 'success' ? 'success' : (type === 'error' ? 'error' : ''));
    toast.setAttribute('role', 'status');
    toast.setAttribute('aria-live', 'polite');
    const msg = document.createElement('div');
    msg.className = 'toast-message';
    msg.textContent = announceTitle ? `${announceTitle} â€” ${message}` : message;
    const close = document.createElement('button');
    close.className = 'toast-close';
    close.setAttribute('aria-label', 'Dismiss notification');
    close.innerHTML = '&times;';
    close.addEventListener('click', () => { if (toast.parentNode) toast.parentNode.removeChild(toast); });
    toast.appendChild(msg);
    toast.appendChild(close);
    container.appendChild(toast);
    close.focus();
    const to = setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, timeout);
    toast._timeout = to;
  }

  // backward compatible alias
  function showMessage(text, type = 'info', timeout = 4000) {
    showToast(text, type === 'error' ? 'error' : (type === 'success' ? 'success' : 'info'), timeout);
  }

  function bindActivateByKeyboard(el) {
    if (!el) return;
    el.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        el.click();
      }
    });
  }

  // Add to cart from wishlist (optimistic: remove item from DOM immediately)
  document.querySelectorAll('.add-to-cart').forEach(btn => {
    bindActivateByKeyboard(btn);
    btn.addEventListener('click', async function() {
      const invId = this.dataset.invId;
      const wishlistItemEl = this.closest('.wishlist-item');
      const wishlistId = wishlistItemEl ? wishlistItemEl.dataset.wishlistId : null;

      // optimistic remove from DOM
      let placeholder = null;
      if (wishlistItemEl) {
        placeholder = document.createComment('wishlist-placeholder-' + (wishlistId || invId));
        wishlistItemEl.parentNode.insertBefore(placeholder, wishlistItemEl.nextSibling);
        wishlistItemEl.remove();
      }

      showMessage('Adding item to cart...', 'info');

      try {
        const response = await fetch('/cart/add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ invId, quantity: 1 })
        });

        const data = await response.json();
        if (data.success) {
          showMessage('Item added to cart.', 'success');
        } else {
          showMessage(data.message || 'Error adding to cart', 'error');
          // rollback: reinsert wishlist item
          if (placeholder && placeholder.parentNode) {
            placeholder.parentNode.insertBefore(wishlistItemEl, placeholder);
            placeholder.remove();
          }
        }
      } catch (error) {
        console.error('Error:', error);
        showMessage('Error adding to cart', 'error');
        if (placeholder && placeholder.parentNode) {
          placeholder.parentNode.insertBefore(wishlistItemEl, placeholder);
          placeholder.remove();
        }
      }
    });
  });

  // Remove from wishlist (optimistic)
  document.querySelectorAll('.remove-item').forEach(btn => {
    bindActivateByKeyboard(btn);
    btn.addEventListener('click', async function() {
      const wishlistId = this.dataset.wishlistId;
      if (!confirm('Are you sure you want to remove this item from your wishlist?')) return;

      const wishlistItemEl = this.closest('.wishlist-item');
      let placeholder = null;
      if (wishlistItemEl) {
        placeholder = document.createComment('wishlist-placeholder-remove-' + wishlistId);
        wishlistItemEl.parentNode.insertBefore(placeholder, wishlistItemEl.nextSibling);
        wishlistItemEl.remove();
      }

      showMessage('Removing item from wishlist...', 'info');

      try {
        const response = await fetch('/wishlist/remove', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ wishlistId })
        });

        const data = await response.json();
        if (data.success) {
          showMessage('Item removed from wishlist.', 'success');
        } else {
          showMessage(data.message || 'Error removing item', 'error');
          if (placeholder && placeholder.parentNode) {
            placeholder.parentNode.insertBefore(wishlistItemEl, placeholder);
            placeholder.remove();
          }
        }
      } catch (error) {
        console.error('Error:', error);
        showMessage('Error removing item', 'error');
        if (placeholder && placeholder.parentNode) {
          placeholder.parentNode.insertBefore(wishlistItemEl, placeholder);
          placeholder.remove();
        }
      }
    });
  });
</script>
