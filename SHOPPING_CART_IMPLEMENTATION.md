# Shopping Cart & Wishlist Implementation Guide

## Overview
This document outlines the implementation of shopping cart and wishlist features for the CSE340 vehicle inventory application.

## Database Schema

### New Tables Created

#### `shopping_cart` Table
```sql
CREATE TABLE IF NOT EXISTS public.shopping_cart (
  cart_id INT GENERATED BY DEFAULT AS IDENTITY,
  account_id INT NOT NULL REFERENCES public.account(account_id) ON DELETE CASCADE,
  inv_id INT NOT NULL REFERENCES public.inventory(inv_id) ON DELETE CASCADE,
  quantity INT NOT NULL DEFAULT 1 CHECK (quantity > 0),
  added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT shopping_cart_pkey PRIMARY KEY (cart_id),
  CONSTRAINT shopping_cart_unique UNIQUE (account_id, inv_id)
);
```

**Features:**
- Stores individual cart items per user
- Tracks quantity for each vehicle
- Timestamps when items are added
- Unique constraint prevents duplicate entries (instead updates quantity)
- Cascade delete when user account is deleted

#### `wishlist` Table
```sql
CREATE TABLE IF NOT EXISTS public.wishlist (
  wishlist_id INT GENERATED BY DEFAULT AS IDENTITY,
  account_id INT NOT NULL REFERENCES public.account(account_id) ON DELETE CASCADE,
  inv_id INT NOT NULL REFERENCES public.inventory(inv_id) ON DELETE CASCADE,
  added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT wishlist_pkey PRIMARY KEY (wishlist_id),
  CONSTRAINT wishlist_unique UNIQUE (account_id, inv_id)
);
```

**Features:**
- Stores wishlist items per user
- Timestamps when items are added
- Unique constraint prevents duplicate entries
- Cascade delete when user account is deleted

## Backend Implementation

### Models

#### `models/cart-model.js`
Provides database operations for shopping cart:
- `getCartByAccountId(accountId)` - Retrieves all items in user's cart with vehicle details
- `getCartItem(accountId, invId)` - Gets specific cart item
- `addToCart(accountId, invId, quantity)` - Adds item or increases quantity
- `updateCartQuantity(cartId, quantity)` - Updates quantity of specific cart item
- `removeFromCart(cartId)` - Removes item from cart
- `clearCart(accountId)` - Empties entire cart

#### `models/wishlist-model.js`
Provides database operations for wishlist:
- `getWishlistByAccountId(accountId)` - Retrieves all items in user's wishlist with vehicle details
- `getWishlistItem(accountId, invId)` - Gets specific wishlist item
- `addToWishlist(accountId, invId)` - Adds item to wishlist
- `removeFromWishlist(wishlistId)` - Removes item from wishlist

### Controllers

#### `controllers/cartController.js`
Handles cart-related requests:
- `viewCart` - Displays cart with all items and total price
- `addToCart` - API endpoint to add items to cart (JSON)
- `updateQuantity` - API endpoint to update item quantity
- `removeItem` - API endpoint to remove item from cart
- `clearCart` - API endpoint to empty cart

All cart operations require user authentication (checks `req.account`).

#### `controllers/wishlistController.js`
Handles wishlist-related requests:
- `viewWishlist` - Displays wishlist with all items
- `addToWishlist` - API endpoint to add items to wishlist
- `removeFromWishlist` - API endpoint to remove items from wishlist

All wishlist operations require user authentication.

### Routes

#### `routes/cartRoute.js`
```javascript
GET  /cart                  - View cart
POST /cart/add              - Add item to cart
POST /cart/update-quantity  - Update item quantity
POST /cart/remove           - Remove item from cart
POST /cart/clear            - Clear entire cart
```

#### `routes/wishlistRoute.js`
```javascript
GET  /wishlist              - View wishlist
POST /wishlist/add          - Add item to wishlist
POST /wishlist/remove       - Remove item from wishlist
```

## Frontend Implementation

### Views

#### `views/cart/view.ejs`
- Displays all items in shopping cart in a table format
- Shows item images, prices, quantities, and subtotals
- Quantity input allows direct modification
- Remove button for individual items
- Clear cart button to empty entire cart
- Checkout button (placeholder for future implementation)
- Responsive design with Bootstrap-style styling
- Client-side JavaScript handles all interactions via fetch API

#### `views/wishlist/view.ejs`
- Displays all items in wishlist in a grid layout
- Shows item images, prices, and vehicle details
- "Add to Cart" button to transfer items to cart
- Remove button to delete from wishlist
- Responsive grid layout that adapts to different screen sizes
- Client-side JavaScript handles all interactions via fetch API

### Detail Page Enhancement

#### `views/inventory/detail.ejs`
Updated to include:
- "Add to Cart" button (if user is logged in)
- "Add to Wishlist" button (if user is logged in)
- Login prompt for non-authenticated users
- Styled buttons with hover effects
- JavaScript event handlers for cart/wishlist operations

## Utilities Updates

### `utilities/index.js`
Updated `buildVehicleDetail()` function:
- Now accepts optional `userAccount` parameter
- Displays action buttons if user is authenticated
- Shows login prompt if user is not authenticated
- Generates HTML with proper data attributes for JavaScript handling

## Usage Flow

### Adding Items to Cart
1. User navigates to vehicle detail page
2. Clicks "Add to Cart" button
3. Frontend sends POST request to `/cart/add` with `invId` and `quantity`
4. Backend validates authentication and vehicle existence
5. Item is added to database (or quantity increased if already present)
6. Success message displayed and cart count updated

### Managing Wishlist
1. User navigates to vehicle detail page
2. Clicks "Add to Wishlist" button
3. Frontend sends POST request to `/wishlist/add` with `invId`
4. Backend validates authentication and checks for duplicates
5. Item is added to database
6. Success message displayed
7. From wishlist page, user can remove items or add them to cart

### Viewing Cart
1. User visits `/cart` URL or clicks cart link
2. Backend retrieves all cart items with vehicle details
3. Calculates total price
4. Displays items in table with quantity controls
5. User can:
   - Update quantities (with automatic save)
   - Remove individual items
   - Clear entire cart
   - Proceed to checkout (placeholder)

### Viewing Wishlist
1. User visits `/wishlist` URL or clicks wishlist link
2. Backend retrieves all wishlist items with vehicle details
3. Displays items in responsive grid
4. User can:
   - View wishlist items
   - Add items to cart from wishlist
   - Remove items from wishlist

## Authentication & Authorization

- All cart and wishlist operations require user authentication
- System uses JWT tokens stored in `req.account` 
- Non-authenticated users redirected to login page
- API endpoints return 401 Unauthorized for invalid requests

## Error Handling

### Database Errors
- Constraint violations handled gracefully
- Duplicate wishlist items return 400 error with message
- Database errors return 500 status with user-friendly message

### Validation
- Item IDs and quantities validated on backend
- Non-existent vehicles return 404 errors
- Invalid quantities handled with range checks

### Client-side Feedback
- Success/error messages displayed to user
- Confirmation dialogs for destructive actions
- Alert notifications for API responses
- Page reloads on successful operations

## Future Enhancements

1. **Checkout Process**
   - Implement payment processing
   - Order creation and management
   - Inventory reduction after purchase

2. **Cart Persistence**
   - Save abandoned carts
   - Email recovery for abandoned carts
   - Cart expiration after 30 days

3. **Wishlist Sharing**
   - Share wishlist with others
   - Generate wishlist links
   - Wishlist notifications for price drops

4. **Advanced Features**
   - Cart discount codes/coupons
   - Estimated shipping calculation
   - Saved payment methods
   - Order history integration

## Testing Checklist

- [ ] User can add items to cart from detail page
- [ ] Quantity increments if same item added twice
- [ ] User can view cart with all items
- [ ] Update quantity refreshes total price
- [ ] Remove item deletes from cart
- [ ] Clear cart empties all items
- [ ] User can add items to wishlist
- [ ] Duplicate wishlist items show error
- [ ] User can view wishlist
- [ ] Remove item deletes from wishlist
- [ ] Add to cart from wishlist works
- [ ] Non-authenticated users cannot access cart/wishlist
- [ ] Price calculations are accurate
- [ ] Responsive design works on mobile

## File Summary

### New Files Created
- `models/cart-model.js` - Cart database operations
- `models/wishlist-model.js` - Wishlist database operations
- `controllers/cartController.js` - Cart request handling
- `controllers/wishlistController.js` - Wishlist request handling
- `routes/cartRoute.js` - Cart routing
- `routes/wishlistRoute.js` - Wishlist routing
- `views/cart/view.ejs` - Cart display template
- `views/wishlist/view.ejs` - Wishlist display template

### Modified Files
- `server.js` - Added cart and wishlist routes
- `database/rebuild.sql` - Added new table definitions
- `utilities/index.js` - Enhanced buildVehicleDetail() function
- `controllers/inventoryController.js` - Pass user account to buildVehicleDetail()
- `views/inventory/detail.ejs` - Added cart/wishlist buttons and scripts
